(function() {
  var require = ['/dropins/setNgMaterial/dibGlobals/js/component/timeDatePickerInput.js','/dropins/setNgMaterial/dibGlobals/js/component/taScrollWindow.js','/dropins/setNgMaterial/dibForm/js/component/formPaging.js','/dropins/setNgMaterial/dibGlobals/js/component/dibImgPreview.js','/dropins/setNgMaterial/dibGlobals/js/component/dibFileUploader.js','/dropins/setNgMaterial/dibMenu/js/components/dibSideBarStatus.js','/dropins/setNgMaterial/dibGlobals/js/component/dibIframe.js',  
		'/dropins/setNgMaterial/dibForm/js/services/dibForm.js'
	];
  require.push('/dropins/setNgMaterial/dibGlobals/js/component/selectDefault.js');
  var files = [];
  angular.forEach(require, function (file,index) { 
    files.push(DIB__base_url+'/files'+file);
  });
          files.push( DIB__base_url + '/dropins/setNgMaterial/dibGrid/Template/controller/dibexComponentGrid.js');
    var dibexComponents = angular.module('dibexComponents', [files]);
    dibexComponents.service('service179858',service179858);
    service179858.$inject = ['ajax', 'discoverService'];
    function service179858(ajax,  discoverService) {
            return {
                list : list
            };
            function list(node) {
                var url = updateQueryStringMenu(DIB__base_url + "/dropins/setNgMaterial/dibMenu/menu/list.json?containerName=dibexComponents&rootMenuId=188605", node);
                var requestInfo = discoverService.addToUrl({
                    field : $('#ci179858'),
                    container : $('[dib-container=dibexComponents]'),
                    url : url
                });
                return ajax.post(requestInfo, {
                    excludeFromCancels : true,
                    factoryResult : function (data) {
                        return data.records;
                    }
                })
            };
    };
    function updateQueryStringMenu(url, node) { 
        if (!!node === true) {
            return url + "&node="+node;
        } 
        return url + "&node=root";
    };
    dibexComponents.service('service154791',service154791); 
    service154791.$inject = ['ajax', 'discoverService', '$q'];
    function service154791(ajax, discoverService, $q) {
            return {
                list : list
            };       
            function list(query, modelType, page) {
                var $defer = $q.defer();
                var url = updateQueryStringDropdown(DIB__base_url + "/peff/Crud/componentlist/dibexComponents?containerItemId=154791", query, modelType, page);
                var requestInfo = discoverService.addToUrl({
                    field :$('#ci154791'),
                    container : $('[dib-container=dibexComponents]'),
                    url : url
                });
                return ajax.post(requestInfo, {
                    excludeFromCancels : true,
                    factoryResult : function (data) {
                        return data.records;
                    }
                });
            };
    };
    dibexComponents.service('service154824',service154824); 
    service154824.$inject = ['ajax', 'discoverService', '$q'];
    function service154824(ajax, discoverService, $q) {
            return {
                list : list
            };       
            function list(query, modelType, page) {
                var $defer = $q.defer();
                var url = updateQueryStringDropdown(DIB__base_url + "/peff/Crud/componentlist/dibexComponents?containerItemId=154824", query, modelType, page);
                var requestInfo = discoverService.addToUrl({
                    activeFilter : 'parentCompanyId',
                    field :$('#ci154824'),
                    container : $('[dib-container=dibexComponents]'),
                    url : url
                });
                return ajax.post(requestInfo, {
                    excludeFromCancels : true,
                    factoryResult : function (data) {
                        return data.records;
                    }
                });
            };
    };
    dibexComponents.service('service154825',service154825); 
    service154825.$inject = ['ajax', 'discoverService', '$q'];
    function service154825(ajax, discoverService, $q) {
            return {
                list : list
            };       
            function list(query, modelType, page) {
                var $defer = $q.defer();
                var url = updateQueryStringDropdown(DIB__base_url + "/peff/Crud/componentlist/dibexComponents?containerItemId=154825", query, modelType, page);
                var requestInfo = discoverService.addToUrl({
                    activeFilter : 'companyId',
                    field :$('#ci154825'),
                    container : $('[dib-container=dibexComponents]'),
                    url : url
                });
                return ajax.post(requestInfo, {
                    excludeFromCancels : true,
                    factoryResult : function (data) {
                        return data.records;
                    }
                });
            };
    };
    function updateQueryStringDropdown(url, query, modelType, page) {
        url += "&limit=20&page=" + (!!page == true? page: 1);
        if (modelType=='search') { 
            url += "&showUsedOnly=true";
        }
        url += "&query=";
        if (!!query == true) {
            url += query;
        }
        return url;
    };
var dibexComponents = angular.module('dibexComponents');
dibexComponents.component('dibexComponents', {
    controllerAs: 'dibexComponents',
    templateUrl: DIB__base_url + '/dropins/setNgMaterial/dibForm/Template/view/dibexComponents.html',
    controller : component__dibexComponents
});
component__dibexComponents.$inject = [  
            'dibForm', '$scope','$element', '$ocLazyLoad', '$rootScope', '$log', 'discoverService', 'messageService','$location','actionService', '$q','utilityService', '$timeout', 'activeFilterOverride','service154791','service154824','service154825','service179858','containerService','recordFactory','crudService','utilityService'];
    function component__dibexComponents(dibForm, $scope,$element, $ocLazyLoad, $rootScope, $log, discoverService, messageService,$location,actionService, $q,utilityService, $timeout, activeFilterOverride,service154791,service154824,service154825,service179858,containerService,recordFactory,crudService,utilityService) {
        var ctrl = this;        
        ctrl.$postLink = function () {
        if (!!$scope) { 
                $scope.$broadcast('postLink');
        }
        };
        ctrl.$onInit = function () {
        if (!!$scope) { 
                $scope.$broadcast('onInit');
        }
                        $scope.container = {};
            $scope.container.Id = '7142';
            $scope.container.Name = 'dibexComponents';
            var crudController = "/peff/Crud";
                    $scope.model = {};
        $scope.model._GET = recordFactory.modelConstruct();
        $scope.model._GET['inputtext'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['inputnumber'] = containerService.modelItem("number", 
            true,
            true,
            null
        );
        $scope.model._GET['datepickerinput'] = containerService.modelItem("date", 
            true,
            true,
            null
        );
        $scope.model._GET['inputemail'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['inputurl'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['mdcheckbox'] = containerService.modelItem("boolean", 
            true,
            true,
            null
        );
        $scope.model._GET['mdselectenum'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['mdautocomplete'] = containerService.modelItem("select", 
            true,
            true,
            service154791
        );
        $scope.model._GET['inputtextarea'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['htmleditor'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['inputnumberdecimal'] = containerService.modelItem("number", 
            true,
            true,
            null
        );
        $scope.model._GET['varchar10_required'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['id'] = containerService.modelItem("number", 
            false,
            false,
            null
        );
        $scope.model._GET['datetime_fld'] = containerService.modelItem("dateTime", 
            true,
            true,
            null
        );
        $scope.model._GET['image_fld'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['file_fld'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['test_company_id'] = containerService.modelItem("select", 
            true,
            true,
            service154824
        );
        $scope.model._GET['test_company2_id'] = containerService.modelItem("select", 
            true,
            true,
            service154825
        );
        $scope.model._GET['mddatefield'] = containerService.modelItem("date", 
            true,
            true,
            null
        );
        $scope.model._GET['timedatepickerinput'] = containerService.modelItem("dateTime", 
            true,
            true,
            null
        );
        $scope.model._GET['inputcheckbox'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['inputdate'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['inputtime'] = containerService.modelItem("time", 
            true,
            true,
            null
        );
        $scope.model._GET['inputdatetimelocal'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['inputmonth'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['inputradio'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['inputweek'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['inputrange'] = containerService.modelItem("text", 
            true,
            true,
            null
        );
        $scope.model._GET['mdcheckboxRt'] = containerService.modelItem("boolean", 
            true,
            true,
            null
        );
        $scope.model._GET['mdswitch'] = containerService.modelItem("boolean", 
            true,
            true,
            null
        );
        $scope.view = {};
            $scope.view.parentCompanyId = {'disabled' : false,'visible' : true, 'class' : null, 'style' : null };
            $scope.view.companyId = {'disabled' : false,'visible' : true, 'class' : null, 'style' : null };
            $scope.view.openMenu = {'disabled' : false,'visible' : true, 'class' : null, 'style' : null };
            $scope.view.sidenavmenu = {'disabled' : false,'visible' : true, 'class' : null, 'style' : null };
            var reloadContainerFunctions = [];
            containerService.watchModel($scope);
	        $scope.common = $rootScope.common;
            $scope.primaryKeys = ["id"];
        $scope.menus = {};
            $scope.menus.service179858 = {};
            $scope.menus.service179858.update = function (node){
                $scope.menus.service179858.loading = true;
                service179858.list(!!node? node.id : null).then(function (menu) {
                    $scope.menus.service179858.loading = false;
                    if (!!node === false) { 
                        $scope.menus.service179858.menu = menu;
                    } else { 
                        node.children = menu;
                    }
                }, function () {
                    $scope.menus.service179858.loading = false;
                });
            };
            $scope.menus.service179858.update();
        $scope.dropdowns = {};
        //load all dropdowns required for this container
            $scope.dropdowns.service154791 = {};
            $scope.dropdowns.service154791.items = [];
            var setTimeoutCancel154791 = null;
            var query154791;
            $scope.loadService154791 = function (query, skipTimeout) {
                //This is to prevent to load any unnessary data as this gets triggered a few times with the multi line editing
                if (query154791 != query) {
                    query154791 = query;
                    if (!!skipTimeout) {
                        return service154791.list(query).then(function (items) {
                            $scope.dropdowns.service154791.items = items;
                        });
                    } else {
                        clearTimeout(setTimeoutCancel154791);
                        setTimeoutCancel154791 = setTimeout(function () { 
                            service154791.list(query).then(function (items) {
                                $scope.dropdowns.service154791.items = items;
                            });
                        }, 100);
                    }
                } 
            };
            $scope.dropdowns.service154791.searchTextChange = function (query) {
                $scope.loadService154791(query);
            };
            $scope.dropdowns.service154791.getItems = function (query,modelType) {
                //return promise this will asign the result to the items
                return service154791.list(query,modelType);
            };
            $scope.select154791 = function (model,modelName,fieldName) {
                if (!!modelName == false) modelName ="model";
                var $element =  $('#ci154791');
                if (!!$element.attr('select-model') === false) { 
                    $element = $element.find('[select-model]');
                }
                var modelName =  'selected___' + fieldName;
                $element.trigger('select');
                if (!!model[modelName]  === false) { 
                    return  false;
                }
                angular.forEach($scope.dropdowns.service154791.items, function (item, index)   {
                    if (item.id == model[modelName]['id']) {
                        model[modelName]['id_display_value'] = item.id_display_value; 
                        return false;
                    }
                });
            };
            var setTimeout154791 = null;
            //loadService154791();
            //reloadContainerFunctions.push($scope.loadService154791);
            $scope.dropdowns.service154824 = {};
            $scope.dropdowns.service154824.items = [];
            var setTimeoutCancel154824 = null;
            var query154824;
            $scope.loadService154824 = function (query, skipTimeout) {
                //This is to prevent to load any unnessary data as this gets triggered a few times with the multi line editing
                if (query154824 != query) {
                    query154824 = query;
                    if (!!skipTimeout) {
                        return service154824.list(query).then(function (items) {
                            $scope.dropdowns.service154824.items = items;
                        });
                    } else {
                        clearTimeout(setTimeoutCancel154824);
                        setTimeoutCancel154824 = setTimeout(function () { 
                            service154824.list(query).then(function (items) {
                                $scope.dropdowns.service154824.items = items;
                            });
                        }, 100);
                    }
                } 
            };
            $scope.dropdowns.service154824.searchTextChange = function (query) {
                $scope.loadService154824(query);
            };
            $scope.dropdowns.service154824.getItems = function (query,modelType) {
                //return promise this will asign the result to the items
                return service154824.list(query,modelType);
            };
            $scope.select154824 = function (model,modelName,fieldName) {
                if (!!modelName == false) modelName ="model";
                var $element =  $('#ci154824');
                if (!!$element.attr('select-model') === false) { 
                    $element = $element.find('[select-model]');
                }
                var modelName =  'selected___' + fieldName;
                $element.trigger('select');
                if (!!model[modelName]  === false) { 
                    return  false;
                }
                angular.forEach($scope.dropdowns.service154824.items, function (item, index)   {
                    if (item.id == model[modelName]['id']) {
                        model[modelName]['id_display_value'] = item.id_display_value; 
                        return false;
                    }
                });
            };
            var setTimeout154824 = null;
            //loadService154824();
            //reloadContainerFunctions.push($scope.loadService154824);
            $scope.dropdowns.service154825 = {};
            $scope.dropdowns.service154825.items = [];
            var setTimeoutCancel154825 = null;
            var query154825;
            $scope.loadService154825 = function (query, skipTimeout) {
                //This is to prevent to load any unnessary data as this gets triggered a few times with the multi line editing
                if (query154825 != query) {
                    query154825 = query;
                    if (!!skipTimeout) {
                        return service154825.list(query).then(function (items) {
                            $scope.dropdowns.service154825.items = items;
                        });
                    } else {
                        clearTimeout(setTimeoutCancel154825);
                        setTimeoutCancel154825 = setTimeout(function () { 
                            service154825.list(query).then(function (items) {
                                $scope.dropdowns.service154825.items = items;
                            });
                        }, 100);
                    }
                } 
            };
            $scope.dropdowns.service154825.searchTextChange = function (query) {
                $scope.loadService154825(query);
            };
            $scope.dropdowns.service154825.getItems = function (query,modelType) {
                //return promise this will asign the result to the items
                return service154825.list(query,modelType);
            };
            $scope.select154825 = function (model,modelName,fieldName) {
                if (!!modelName == false) modelName ="model";
                var $element =  $('#ci154825');
                if (!!$element.attr('select-model') === false) { 
                    $element = $element.find('[select-model]');
                }
                var modelName =  'selected___' + fieldName;
                $element.trigger('select');
                if (!!model[modelName]  === false) { 
                    return  false;
                }
                angular.forEach($scope.dropdowns.service154825.items, function (item, index)   {
                    if (item.id == model[modelName]['id']) {
                        model[modelName]['id_display_value'] = item.id_display_value; 
                        return false;
                    }
                });
            };
            var setTimeout154825 = null;
            //loadService154825();
            //reloadContainerFunctions.push($scope.loadService154825);
            $scope.openAuditTrail = function (portAlias) {
                            var primaryKeyData = recordFactory.primaryKeyAuditIds($scope.primaryKeys, $scope.model);
                            if (primaryKeyData.length > 0) {
                            $scope.common.goTo(DIB__audit_trail_container,portAlias,true,"?filter_pef_table_id=1437&filter_record_id="+primaryKeyData);
                        } else {
                            $scope.common.goTo(DIB__audit_trail_container,portAlias,true,"?filter_pef_table_id=1437");
                        }
            };
            $scope.addModel = function () { 
                dibForm.addModel($scope, "dibexComponents");
            };
            $scope.deleteRecord = function (options) {
                dibForm.deleteRecord('dibexComponents', $scope, $scope.dibexComponents, options, crudController).then(function (){
        if (!!$scope) { 
                $scope.$broadcast('delete');
        }
                });
            };         
            /**
            *  Saving record in this model
            */
            $scope.saveModel = function (options) {
                if ($scope.loadingData) return $q.reject('Busy loading...');
                if (dibForm.validate($scope, $scope.dibexComponents)) {
        if (!!$scope) { 
                $scope.$broadcast('beforeUpdate');
        }
                    $scope.loadingData =  true;
                    var primaryKeyData = recordFactory.primaryKeyData($scope.primaryKeys, $scope.model);
                    return dibForm.updateRecord('dibexComponents', $scope, $scope.dibexComponents, crudController, options).then(function () { 
                        if (Object.keys(primaryKeyData).length>0) {
        if (!!$scope) { 
                $scope.$broadcast('update');
        }
                        } else {
        if (!!$scope) { 
                $scope.$broadcast('create');
        }
                            loadForm();
                        }
                        return $q.when();
                    });
                }
            };
            var mdTabs = $("[dib-container=dibexComponents]").closest('md-tabs');
            var tabsScope = null;
            if (mdTabs.length === 0) {
                mdTabs = null;
            }
            else {
                tabsScope = mdTabs.scope();
            }
            $scope.$watch('dibexComponents.$dirty', function (newValue, oldValue) { 
                $rootScope._navigation.containerDirty = newValue;
                if ($rootScope._navigation.containerDirty && !!mdTabs && !!tabsScope) {
                    var currentIndex = tabsScope.selectedIndex;
                    $rootScope._navigation.addSaveFailedPromise(function(tabIndex) {
                        tabsScope.selectedIndex = tabIndex;
                        return $q.when();
                    }, [currentIndex]);
                }
            },true);
            $rootScope._navigation.addSavePromise($scope.saveModel);
            //Giving the form the ability to handle dependency data (if an event is trigger on another component that has a refresh item alias point to the form/child form)
            $scope.setDependencyData = function (object) { 
                return dibForm.setDependencyData($scope,object);
            };
            $scope.itemAliasData = function () {
                return angular.copy($scope.primaryKeyData);
            };
            /**
            * Clear the form from records and dependancy data
            */
            $scope.clearForm = function () {
                if ($scope.loadingData) return;
                $scope.primaryKeyData = null;
                $scope.reloadContainer();
                dibForm.clean($scope.dibexComponents,$scope.model);
        if (!!$scope) { 
                $scope.$broadcast('clearDependency');
        }
            };
            function loadForm () { 
                $rootScope._navigation.reset();
                $rootScope._navigation.addSavePromise($scope.saveModel);
        if (!!$scope) { 
                $scope.$broadcast('beforeLoad');
        }
                //clear the record status
                $scope.recordStatus = null;
                var isUrlContainer = containerService.urlContainer('dibexComponents');
                if (isUrlContainer) {
                    //check if record is first or last
                    if (!!$location.search()['record'] && $location.search()['record']!='new') {
                        return;
                    }
                }
                //check if this is a child container 
                $scope.primaryKeyData = isUrlContainer ? discoverService.getPrimaryKeysFromUrl() : $scope.primaryKeyData;
                if (!!$scope.primaryKeyData === false) {
                $scope.primaryKeyData = {};
                //set all the primaryKeys to 0
                angular.forEach($scope.primaryKeys, function (key,index) { 
                    $scope.model[key] = 0;
                });
                }
                //remove active filter if no record are available
                if (Object.keys($scope.primaryKeyData).length ==0) {
                    $scope.recordStatus = "create";
                } else {
                    $scope.recordStatus = "update";
                }
                $scope.loadingData = true;
                $scope.currentPrimaryKeyData = $scope.primaryKeyData;
                crudService.read(crudController,'dibexComponents',{
                    primaryKeyData : $scope.currentPrimaryKeyData,
                    createParams: "{}"
                },
                $scope
                ).then(function (model) {
                    $scope.model = model;
                    $scope.currentPrimaryKeyData = recordFactory.primaryKeyData($scope.primaryKeys, $scope.model);
        if (!!$scope) { 
                $scope.$broadcast('load');
        }
                    $scope.dibexComponents.$setUntouched();
                    $scope.dibexComponents.$setPristine();
                    //@TODO refactor start 
                    var timeoutTest = $timeout(function () { 
                        containerService.reloadChildren({containerName: 'dibexComponents'});
                    },500); 
                    //@FRANCOIS @TODO Maybe we can change this to a better magic number :)
                    var eventDeregister = $rootScope.$on("dibAngular.subcontainerLoaded", function () {
                        $timeout.cancel(timeoutTest);
                        timeoutTest = $timeout(function () { 
                            containerService.reloadChildren({containerName: 'dibexComponents'});
                            eventDeregister();
                        },500); 
                        //@FRANCOIS @TODO Maybe we can change this to a better magic number :)
                    });
                    //Refactor stop
                    $log.debug("containerName read->model",$scope.model );
                    $scope.loadingData =  false;
                }, function () {
                    $scope.loadingData =  false;
                });
            }
            $scope.reloadContainer = function (options) {
        if (!!$scope) { 
                $scope.$broadcast('beforeContainerReload');
        }
                $scope.autoRefresh = true;
                loadForm ();
        if (!!$scope) { 
                $scope.$broadcast('reloadContainer');
        }
            };
            //var isUrlContainer = containerService.urlContainer('dibexComponents');
            //the if below we removed the requirement to match the url to the containerName, so we can load data into a window without the url changing. wizBuildAppAdv.
            loadForm();
            $scope.$watch('model', function (oldVal, newVal) {
        if (!!$scope) { 
                $scope.$broadcast('modelChange');
        }
            },true);  
        }
    }
})();
